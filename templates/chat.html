<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat - Discord-like App</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <style>
        /* Emoji Picker Styles */
        .emoji-picker {
            position: absolute;
            bottom: 60px;
            right: 60px;
            width: 300px;
            height: 250px;
            background: #2f3136;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            display: none;
            z-index: 1000;
            overflow: hidden;
        }

        .emoji-picker-header {
            padding: 12px;
            border-bottom: 1px solid #40444b;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .emoji-picker-header h4 {
            margin: 0;
            color: #fff;
            font-size: 14px;
        }

        .emoji-categories {
            display: flex;
            gap: 8px;
            padding: 8px;
            background: #202225;
            border-bottom: 1px solid #40444b;
        }

        .emoji-category-btn {
            background: transparent;
            border: none;
            color: #b9bbbe;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 18px;
        }

        .emoji-category-btn:hover,
        .emoji-category-btn.active {
            background: #40444b;
            color: #fff;
        }

        .emoji-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 4px;
            padding: 8px;
            height: 170px;
            overflow-y: auto;
        }

        .emoji-btn {
            background: transparent;
            border: none;
            color: #fff;
            font-size: 20px;
            padding: 4px;
            cursor: pointer;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .emoji-btn:hover {
            background: #40444b;
        }

        .emoji-search {
            padding: 8px;
            border-top: 1px solid #40444b;
        }

        .emoji-search input {
            width: 100%;
            padding: 6px 8px;
            background: #202225;
            border: 1px solid #40444b;
            border-radius: 4px;
            color: #fff;
            font-size: 14px;
        }

        /* Room item delete button */
        .room-item {
            position: relative;
            padding-right: 40px !important;
        }

        .delete-room-btn {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            background: transparent;
            border: none;
            color: #72767d;
            cursor: pointer;
            padding: 2px 4px;
            border-radius: 4px;
            opacity: 0;
            transition: opacity 0.2s, background 0.2s;
        }

        .room-item:hover .delete-room-btn {
            opacity: 1;
        }

        .delete-room-btn:hover {
            background: #ed4245;
            color: #fff;
        }
    </style>
</head>
<body class="chat-page">
    <div class="chat-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h2><i class="fas fa-comments"></i> ChatApp</h2>
                <div class="user-info">
                    <span class="username">{{ username }}</span>
                    <a href="{{ url_for('logout') }}" class="logout-btn">
                        <i class="fas fa-sign-out-alt"></i>
                    </a>
                </div>
            </div>
            
            <div class="rooms-section">
                <h3><i class="fas fa-hashtag"></i> Rooms</h3>
                <ul class="rooms-list" id="rooms-list">
                    {% for room in rooms %}
                    <li class="room-item {% if loop.first %}active{% endif %}" 
                        data-room="{{ room }}" onclick="joinRoom('{{ room }}')">
                        <i class="fas fa-hashtag"></i> {{ room }}
                        {% if room not in ['general', 'random', 'help'] %}
                        <button class="delete-room-btn" onclick="deleteRoom('{{ room }}', event)">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                        {% endif %}
                    </li>
                    {% endfor %}
                </ul>
                
                <div class="create-room">
                    <input type="text" id="new-room" placeholder="Create new room...">
                    <button onclick="createRoom()">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
            </div>
            
            <div class="online-users">
                <h3><i class="fas fa-users"></i> Online Users</h3>
                <ul class="users-list" id="users-list">
                    <!-- Online users will be added dynamically -->
                </ul>
            </div>
        </div>
        
        <!-- Main Chat Area -->
        <div class="main-chat">
            <div class="chat-header">
                <div class="current-room">
                    <h2 id="current-room-name">#general</h2>
                    <span class="room-topic" id="room-topic">General discussion</span>
                </div>
                <div class="room-actions">
                    <button class="btn btn-icon" title="Invite users">
                        <i class="fas fa-user-plus"></i>
                    </button>
                    <button class="btn btn-icon" title="Room settings">
                        <i class="fas fa-cog"></i>
                    </button>
                </div>
            </div>
            
            <div class="messages-container" id="messages-container">
                <!-- Messages will be loaded here -->
                {% for message in messages|reverse %}
                <div class="message" data-message-id="{{ message.id }}" data-username="{{ message.username }}" data-timestamp="{{ message.timestamp }}">
                    <div class="message-header">
                        <span class="message-user">{{ message.username }}</span>
                        <span class="message-time">{{ message.timestamp }}</span>
                    </div>
                    <div class="message-content">
                        {% if message.file_path %}
                            {% if message.file_type and message.file_type.startswith('image/') %}
                                <div class="file-message">
                                    <p class="file-name">{{ message.content }}</p>
                                    <img src="{{ url_for('static', filename='uploads/' + message.file_path.split('/')[-1]) if message.file_path.startswith('static/') else '/' + message.file_path }}" 
                                         alt="{{ message.content }}" 
                                         class="uploaded-image"
                                         onclick="openImageModal(this.src)">
                                </div>
                            {% else %}
                                <div class="file-message">
                                    <i class="fas fa-file"></i>
                                    <a href="{{ url_for('static', filename='uploads/' + message.file_path.split('/')[-1]) if message.file_path.startswith('static/') else '/' + message.file_path }}" 
                                       target="_blank" 
                                       class="file-link">
                                        {{ message.content }}
                                    </a>
                                    <span class="file-size">({{ ((message.file_size or 0) / 1024)|round(1) }} KB)</span>
                                </div>
                            {% endif %}
                        {% else %}
                            {{ message.content }}
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
            
            <div class="message-input-container">
                <form id="message-form">
                    <input type="text" id="message-input" 
                           placeholder="Type your message here..." 
                           autocomplete="off" required>
                    <button type="submit" class="btn btn-primary send-btn">
                        <i class="fas fa-paper-plane"></i> Send
                    </button>
                </form>
                <div class="input-actions">
                    <input type="file" id="file-input" style="display: none;" 
                           accept=".png,.jpg,.jpeg,.gif,.bmp,.webp,.pdf,.txt,.doc,.docx,.zip">
                    <button class="btn btn-icon" title="Attach file" onclick="document.getElementById('file-input').click()">
                        <i class="fas fa-paperclip"></i>
                    </button>
                    <button class="btn btn-icon" title="Emoji" id="emoji-btn">
                        <i class="fas fa-smile"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Emoji Picker -->
    <div class="emoji-picker" id="emoji-picker">
        <div class="emoji-picker-header">
            <h4>Emoji Picker</h4>
            <button onclick="closeEmojiPicker()" style="background:transparent;border:none;color:#fff;cursor:pointer;">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="emoji-categories" id="emoji-categories">
            <!-- Categories will be added dynamically -->
        </div>
        <div class="emoji-grid" id="emoji-grid">
            <!-- Emojis will be added dynamically -->
        </div>
        <div class="emoji-search">
            <input type="text" id="emoji-search" placeholder="Search emojis..." oninput="searchEmojis(this.value)">
        </div>
    </div>

    <!-- Image Modal -->
    <div id="image-modal" class="modal" style="display: none;">
        <span class="close-modal" onclick="closeImageModal()">&times;</span>
        <img class="modal-content" id="modal-image">
    </div>

    <script>
        const socket = io();
        let currentRoom = 'general';
        let lastMessageUser = null;
        let lastMessageTime = null;
        const GROUP_TIME_WINDOW = 5 * 60 * 1000; // 5 minutes in milliseconds
        
        // Emoji data
        const emojiCategories = {
            'smileys': ['ðŸ˜€', 'ðŸ˜ƒ', 'ðŸ˜„', 'ðŸ˜', 'ðŸ˜†', 'ðŸ˜…', 'ðŸ˜‚', 'ðŸ¤£', 'ðŸ˜Š', 'ðŸ˜‡', 'ðŸ™‚', 'ðŸ™ƒ', 'ðŸ˜‰', 'ðŸ˜Œ', 'ðŸ˜', 'ðŸ¥°', 'ðŸ˜˜', 'ðŸ˜—', 'ðŸ˜™', 'ðŸ˜š', 'ðŸ˜‹', 'ðŸ˜›', 'ðŸ˜', 'ðŸ˜œ', 'ðŸ¤ª', 'ðŸ¤¨', 'ðŸ§', 'ðŸ¤“', 'ðŸ˜Ž', 'ðŸ¤©', 'ðŸ¥³'],
            'people': ['ðŸ‘‹', 'ðŸ¤š', 'ðŸ–', 'âœ‹', 'ðŸ––', 'ðŸ‘Œ', 'ðŸ¤Œ', 'ðŸ¤', 'âœŒï¸', 'ðŸ¤ž', 'ðŸ¤Ÿ', 'ðŸ¤˜', 'ðŸ¤™', 'ðŸ‘ˆ', 'ðŸ‘‰', 'ðŸ‘†', 'ðŸ–•', 'ðŸ‘‡', 'â˜ï¸', 'ðŸ‘', 'ðŸ‘Ž', 'âœŠ', 'ðŸ‘Š', 'ðŸ¤›', 'ðŸ¤œ', 'ðŸ‘', 'ðŸ™Œ', 'ðŸ‘', 'ðŸ¤²', 'ðŸ™'],
            'animals': ['ðŸ¶', 'ðŸ±', 'ðŸ­', 'ðŸ¹', 'ðŸ°', 'ðŸ¦Š', 'ðŸ»', 'ðŸ¼', 'ðŸ¨', 'ðŸ¯', 'ðŸ¦', 'ðŸ®', 'ðŸ·', 'ðŸ¸', 'ðŸµ', 'ðŸ™ˆ', 'ðŸ™‰', 'ðŸ™Š', 'ðŸ”', 'ðŸ§', 'ðŸ¦', 'ðŸ¤', 'ðŸ£', 'ðŸ¥', 'ðŸ¦†', 'ðŸ¦…', 'ðŸ¦‰', 'ðŸ¦‡', 'ðŸº', 'ðŸ—'],
            'food': ['ðŸŽ', 'ðŸ', 'ðŸŠ', 'ðŸ‹', 'ðŸŒ', 'ðŸ‰', 'ðŸ‡', 'ðŸ“', 'ðŸ«', 'ðŸˆ', 'ðŸ’', 'ðŸ‘', 'ðŸ¥­', 'ðŸ', 'ðŸ¥¥', 'ðŸ¥', 'ðŸ…', 'ðŸ†', 'ðŸ¥‘', 'ðŸ¥¦', 'ðŸ¥¬', 'ðŸ¥’', 'ðŸŒ¶', 'ðŸ«‘', 'ðŸŒ½', 'ðŸ¥•', 'ðŸ«’', 'ðŸ§„', 'ðŸ§…', 'ðŸ¥”'],
            'activities': ['âš½', 'ðŸ€', 'ðŸˆ', 'âš¾', 'ðŸ¥Ž', 'ðŸŽ¾', 'ðŸ', 'ðŸ‰', 'ðŸ¥', 'ðŸŽ±', 'ðŸª€', 'ðŸ“', 'ðŸ¸', 'ðŸ’', 'ðŸ‘', 'ðŸ¥', 'ðŸ', 'ðŸªƒ', 'ðŸ¥…', 'â›³', 'ðŸª', 'ðŸ¹', 'ðŸŽ£', 'ðŸ¤¿', 'ðŸ¥Š', 'ðŸ¥‹', 'ðŸŽ½', 'ðŸ›¹', 'ðŸ›¼', 'ðŸ›·'],
            'objects': ['ðŸ’Ž', 'ðŸ”ª', 'ðŸ§¨', 'ðŸª“', 'â›ï¸', 'ðŸ› ï¸', 'ðŸ—¡ï¸', 'âš”ï¸', 'ðŸ”«', 'ðŸ¹', 'ðŸ›¡ï¸', 'ðŸ”§', 'ðŸ”©', 'âš™ï¸', 'ðŸ—œï¸', 'âš–ï¸', 'ðŸ”—', 'â›“ï¸', 'ðŸ§°', 'ðŸ§²', 'ðŸª›', 'ðŸ”¦', 'ðŸ•¯ï¸', 'ðŸ”Œ', 'ðŸ”‹', 'ðŸª«', 'ðŸ’¡', 'ðŸ”¦', 'ðŸ•¯ï¸', 'ðŸª”'],
            'symbols': ['â¤ï¸', 'ðŸ§¡', 'ðŸ’›', 'ðŸ’š', 'ðŸ’™', 'ðŸ’œ', 'ðŸ–¤', 'ðŸ¤', 'ðŸ¤Ž', 'ðŸ’”', 'â¤ï¸â€ðŸ”¥', 'â¤ï¸â€ðŸ©¹', 'ðŸ’•', 'ðŸ’ž', 'ðŸ’“', 'ðŸ’—', 'ðŸ’–', 'ðŸ’˜', 'ðŸ’', 'ðŸ’Ÿ', 'â˜®ï¸', 'âœï¸', 'â˜ªï¸', 'ðŸ•‰', 'â˜¸ï¸', 'âœ¡ï¸', 'ðŸ”¯', 'ðŸ•Ž', 'â˜¯ï¸', 'â˜¦ï¸'],
            'flags': ['ðŸ³ï¸', 'ðŸ´', 'ðŸ', 'ðŸš©', 'ðŸ³ï¸â€ðŸŒˆ', 'ðŸ³ï¸â€âš§ï¸', 'ðŸ‡ºðŸ‡³', 'ðŸ‡¦ðŸ‡«', 'ðŸ‡¦ðŸ‡½', 'ðŸ‡¦ðŸ‡±', 'ðŸ‡©ðŸ‡¿', 'ðŸ‡¦ðŸ‡¸', 'ðŸ‡¦ðŸ‡©', 'ðŸ‡¦ðŸ‡´', 'ðŸ‡¦ðŸ‡®', 'ðŸ‡¦ðŸ‡¶', 'ðŸ‡¦ðŸ‡¬', 'ðŸ‡¦ðŸ‡·', 'ðŸ‡¦ðŸ‡²', 'ðŸ‡¦ðŸ‡¼', 'ðŸ‡¦ðŸ‡º', 'ðŸ‡¦ðŸ‡¹', 'ðŸ‡¦ðŸ‡¿', 'ðŸ‡§ðŸ‡¸', 'ðŸ‡§ðŸ‡­', 'ðŸ‡§ðŸ‡©', 'ðŸ‡§ðŸ‡§', 'ðŸ‡§ðŸ‡¾', 'ðŸ‡§ðŸ‡ª', 'ðŸ‡§ðŸ‡¿']
        };

        let isEmojiPickerOpen = false;

        socket.on('connect', function() {
            console.log('Connected to server');
            joinRoom(currentRoom);
            groupExistingMessages();
            initEmojiPicker();
        });
        
        socket.on('new_message', function(data) {
            if (data.room === currentRoom) {
                addMessage(data);
            }
        });
        
        socket.on('room_history', function(data) {
            if (data.room === currentRoom) {
                document.getElementById('messages-container').innerHTML = '';
                data.messages.reverse().forEach(addMessage);
                groupExistingMessages();
                scrollToBottom();
            }
        });
        
        socket.on('system_message', function(data) {
            if (data.room === currentRoom) {
                addSystemMessage(data.message);
            }
        });
        
        socket.on('user_status', function(data) {
            updateUserStatus(data.username, data.status);
        });

        socket.on('room_deleted', function(data) {
            const roomName = data.room;
            
            // If we're in the deleted room, switch to general
            if (currentRoom === roomName) {
                joinRoom('general');
                addSystemMessage(`Room #${roomName} was deleted. Switched to #general.`);
            }
            
            // Remove the room from the sidebar
            const roomItems = document.querySelectorAll('.room-item');
            roomItems.forEach(item => {
                if (item.dataset.room === roomName) {
                    item.remove();
                }
            });
        });
        
        // File upload handling
        document.getElementById('file-input').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            // Check file size (16MB limit)
            if (file.size > 16 * 1024 * 1024) {
                alert('File size must be less than 16MB');
                e.target.value = '';
                return;
            }
            
            // Check file extension
            const allowedExtensions = ['png', 'jpg', 'jpeg', 'gif', 'bmp', 'webp', 'pdf', 'txt', 'doc', 'docx', 'zip'];
            const fileExtension = file.name.split('.').pop().toLowerCase();
            if (!allowedExtensions.includes(fileExtension)) {
                alert('File type not allowed. Allowed: ' + allowedExtensions.join(', '));
                e.target.value = '';
                return;
            }
            
            // Create FormData and upload
            const formData = new FormData();
            formData.append('file', file);
            formData.append('room', currentRoom);
            
            // Show upload indicator
            addSystemMessage(`Uploading ${file.name}...`);
            
            fetch('/api/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    addSystemMessage(`Upload failed: ${data.error}`);
                }
                // Clear file input
                e.target.value = '';
            })
            .catch(error => {
                addSystemMessage('Upload failed. Please try again.');
                console.error('Upload error:', error);
                e.target.value = '';
            });
        });
        
        function joinRoom(room) {
            if (currentRoom === room) return;
            
            socket.emit('leave_room', {room: currentRoom});
            currentRoom = room;
            socket.emit('join_room', {room: room});
            
            // Reset grouping state
            lastMessageUser = null;
            lastMessageTime = null;
            
            // Update UI
            document.getElementById('current-room-name').textContent = '#' + room;
            
            // Update active room in sidebar
            document.querySelectorAll('.room-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.room === room) {
                    item.classList.add('active');
                }
            });
            
            // Fetch room messages via API
            fetch(`/api/messages/${room}`)
                .then(response => response.json())
                .then(messages => {
                    const container = document.getElementById('messages-container');
                    container.innerHTML = '';
                    messages.reverse().forEach(m => addMessage(m, false));
                    groupExistingMessages();
                    scrollToBottom();
                });
        }
        
        function createRoom() {
            const roomInput = document.getElementById('new-room');
            const roomName = roomInput.value.trim();
            
            if (roomName) {
                // Check if room already exists
                const existingRooms = Array.from(document.querySelectorAll('.room-item')).map(item => item.dataset.room);
                if (existingRooms.includes(roomName)) {
                    alert(`Room #${roomName} already exists!`);
                    return;
                }
                
                // Add to rooms list
                const roomsList = document.getElementById('rooms-list');
                const roomItem = document.createElement('li');
                roomItem.className = 'room-item';
                roomItem.dataset.room = roomName;
                roomItem.innerHTML = `
                    <i class="fas fa-hashtag"></i> ${roomName}
                    <button class="delete-room-btn" onclick="deleteRoom('${roomName}', event)">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                `;
                roomItem.onclick = () => joinRoom(roomName);
                roomsList.appendChild(roomItem);
                
                // Create system message in the new room
                socket.emit('send_message', {
                    room: roomName,
                    content: `Welcome to #${roomName}!`
                });
                
                roomInput.value = '';
                joinRoom(roomName);
            }
        }

        function deleteRoom(roomName, event) {
            if (event) event.stopPropagation();
            
            if (roomName === 'general' || roomName === 'random' || roomName === 'help') {
                alert('Cannot delete default rooms!');
                return;
            }
            
            if (!confirm(`Are you sure you want to delete room #${roomName}? This action cannot be undone.`)) {
                return;
            }
            
            fetch(`/api/room/${roomName}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(data.error);
                } else {
                    // If we're in the deleted room, switch to general
                    if (currentRoom === roomName) {
                        joinRoom('general');
                    }
                    // Remove the room from the sidebar
                    const roomItems = document.querySelectorAll('.room-item');
                    roomItems.forEach(item => {
                        if (item.dataset.room === roomName) {
                            item.remove();
                        }
                    });
                }
            })
            .catch(error => {
                console.error('Error deleting room:', error);
                alert('Failed to delete room. Please try again.');
            });
        }
        
        document.getElementById('message-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const input = document.getElementById('message-input');
            const message = input.value.trim();
            
            if (message) {
                socket.emit('send_message', {
                    room: currentRoom,
                    content: message
                });
                input.value = '';
                input.focus();
            }
        });

        // Emoji picker functionality
        function initEmojiPicker() {
            const emojiBtn = document.getElementById('emoji-btn');
            const emojiPicker = document.getElementById('emoji-picker');
            
            emojiBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                toggleEmojiPicker();
            });
            
            // Close emoji picker when clicking outside
            document.addEventListener('click', function() {
                if (isEmojiPickerOpen) {
                    closeEmojiPicker();
                }
            });
            
            // Prevent closing when clicking inside the picker
            emojiPicker.addEventListener('click', function(e) {
                e.stopPropagation();
            });
            
            // Populate emoji categories
            const categoriesContainer = document.getElementById('emoji-categories');
            let firstCategory = null;
            
            for (const category in emojiCategories) {
                if (!firstCategory) firstCategory = category;
                
                const button = document.createElement('button');
                button.className = 'emoji-category-btn';
                button.textContent = emojiCategories[category][0]; // Use first emoji as icon
                button.dataset.category = category;
                button.onclick = () => showEmojiCategory(category);
                
                categoriesContainer.appendChild(button);
            }
            
            // Show first category by default
            if (firstCategory) {
                showEmojiCategory(firstCategory);
                const firstBtn = categoriesContainer.querySelector(`[data-category="${firstCategory}"]`);
                firstBtn.classList.add('active');
            }
        }
        
        function toggleEmojiPicker() {
            const emojiPicker = document.getElementById('emoji-picker');
            if (isEmojiPickerOpen) {
                closeEmojiPicker();
            } else {
                openEmojiPicker();
            }
        }
        
        function openEmojiPicker() {
            const emojiPicker = document.getElementById('emoji-picker');
            emojiPicker.style.display = 'block';
            isEmojiPickerOpen = true;
        }
        
        function closeEmojiPicker() {
            const emojiPicker = document.getElementById('emoji-picker');
            emojiPicker.style.display = 'none';
            isEmojiPickerOpen = false;
        }
        
        function showEmojiCategory(category) {
            const emojiGrid = document.getElementById('emoji-grid');
            const categoryButtons = document.querySelectorAll('.emoji-category-btn');
            
            // Update active category button
            categoryButtons.forEach(btn => {
                if (btn.dataset.category === category) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
            
            // Clear and populate emoji grid
            emojiGrid.innerHTML = '';
            
            if (emojiCategories[category]) {
                emojiCategories[category].forEach(emoji => {
                    const button = document.createElement('button');
                    button.className = 'emoji-btn';
                    button.textContent = emoji;
                    button.onclick = () => insertEmoji(emoji);
                    emojiGrid.appendChild(button);
                });
            }
        }
        
        function searchEmojis(query) {
            const emojiGrid = document.getElementById('emoji-grid');
            emojiGrid.innerHTML = '';
            
            if (!query.trim()) {
                // Show current category if no search
                const activeBtn = document.querySelector('.emoji-category-btn.active');
                if (activeBtn) {
                    showEmojiCategory(activeBtn.dataset.category);
                }
                return;
            }
            
            const searchTerm = query.toLowerCase();
            let foundEmojis = [];
            
            // Search through all emojis
            for (const category in emojiCategories) {
                emojiCategories[category].forEach(emoji => {
                    // You could add more sophisticated search here
                    // For now, just show all emojis when searching
                    foundEmojis.push(emoji);
                });
            }
            
            // Display found emojis
            foundEmojis.slice(0, 64).forEach(emoji => { // Limit to 64 emojis for performance
                const button = document.createElement('button');
                button.className = 'emoji-btn';
                button.textContent = emoji;
                button.onclick = () => insertEmoji(emoji);
                emojiGrid.appendChild(button);
            });
        }
        
        function insertEmoji(emoji) {
            const input = document.getElementById('message-input');
            const start = input.selectionStart;
            const end = input.selectionEnd;
            const text = input.value;
            
            input.value = text.substring(0, start) + emoji + text.substring(end);
            input.focus();
            input.selectionStart = input.selectionEnd = start + emoji.length;
            
            // Close the emoji picker after inserting
            closeEmojiPicker();
        }
        
        function addMessage(data, wantToGroup=true) {
            const container = document.getElementById('messages-container');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message';
            messageDiv.dataset.messageId = data.id;
            messageDiv.dataset.username = data.username;
            messageDiv.dataset.timestamp = data.timestamp;
            
            const time = new Date(data.timestamp);
            const displayTime = time.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            // Check if this message should be grouped with the previous one
            const shouldGroup = lastMessageUser === data.username && 
                               lastMessageTime && 
                               (time - lastMessageTime) <= GROUP_TIME_WINDOW &&
                               wantToGroup;
            //const shouldGroup = false;
            
            let contentHtml = '';
            if (data.is_file || data.file_path) {
                const filePath = data.file_path || '';
                const fileName = data.file_name || data.content;
                const fileType = data.file_type || '';
                const fileSize = data.file_size || 0;
                
                // Handle image files
                if (fileType.startsWith('image/') || fileName.match(/\.(png|jpg|jpeg|gif|bmp|webp)$/i)) {
                    const imageUrl = filePath.startsWith('/') ? filePath : '/' + filePath;
                    contentHtml = `
                        <div class="file-message">
                            <p class="file-name">${escapeHtml(fileName)}</p>
                            <img src="${imageUrl}" 
                                 alt="${escapeHtml(fileName)}" 
                                 class="uploaded-image"
                                 onclick="openImageModal('${imageUrl}')">
                        </div>
                    `;
                } else {
                    // Handle other file types
                    const fileUrl = filePath.startsWith('/') ? filePath : '/' + filePath;
                    const fileSizeKB = fileSize ? (fileSize / 1024).toFixed(1) : '0';
                    contentHtml = `
                        <div class="file-message">
                            <i class="fas fa-file"></i>
                            <a href="${fileUrl}" target="_blank" class="file-link">
                                ${escapeHtml(fileName)}
                            </a>
                            <span class="file-size">(${fileSizeKB} KB)</span>
                        </div>
                    `;
                }
            } else {
                contentHtml = `<div class="text-content">${escapeHtml(data.content)}</div>`;
            }
            
            if (shouldGroup) {
                messageDiv.classList.add('grouped');
                messageDiv.innerHTML = `
                    <div class="message-content grouped-content">${contentHtml}</div>
                `;
            } else {
                messageDiv.innerHTML = `
                    <div class="message-header">
                        <span class="message-user">${data.username}</span>
                        <span class="message-time">${displayTime}</span>
                    </div>
                    <div class="message-content">${contentHtml}</div>
                `;
            }
            
            container.appendChild(messageDiv);
            lastMessageUser = data.username;
            lastMessageTime = time;
            scrollToBottom();
        }
        
        function groupExistingMessages() {
            const container = document.getElementById('messages-container');
            const messages = container.querySelectorAll('.message');
            
            if (messages.length === 0) {
                lastMessageUser = null;
                lastMessageTime = null;
                return;
            }
            
            let lastUser = null;
            let lastTime = null;
            
            messages.forEach((message, index) => {
                const username = message.dataset.username;
                const timestamp = message.dataset.timestamp;
                const time = new Date(timestamp);
                
                // Check if this message should be grouped with the previous one
                const shouldGroup = lastUser === username && 
                                   lastTime && 
                                   (time - lastTime) <= GROUP_TIME_WINDOW;
                
                if (shouldGroup) {
                    message.classList.add('grouped');
                    // Hide the message header if it exists
                    const header = message.querySelector('.message-header');
                    if (header) {
                        header.style.display = 'none';
                    }
                    // Wrap the content in a grouped-content div for consistent styling
                    const content = message.querySelector('.message-content');
                    if (content && !content.classList.contains('grouped-content')) {
                        content.classList.add('grouped-content');
                    }
                } else {
                    message.classList.remove('grouped');
                    // Show the message header if it exists
                    const header = message.querySelector('.message-header');
                    if (header) {
                        header.style.display = 'flex';
                    }
                    // Remove grouped-content class
                    const content = message.querySelector('.message-content');
                    if (content && content.classList.contains('grouped-content')) {
                        content.classList.remove('grouped-content');
                    }
                }
                
                lastUser = username;
                lastTime = time;
            });
            
            // Update global tracking variables
            if (messages.length > 0) {
                const lastMessage = messages[messages.length - 1];
                lastMessageUser = lastMessage.dataset.username;
                lastMessageTime = new Date(lastMessage.dataset.timestamp);
            } else {
                lastMessageUser = null;
                lastMessageTime = null;
            }
        }
        
        function addSystemMessage(message) {
            const container = document.getElementById('messages-container');
            const systemDiv = document.createElement('div');
            systemDiv.className = 'system-message';
            systemDiv.innerHTML = `<span>${escapeHtml(message)}</span>`;
            container.appendChild(systemDiv);
            scrollToBottom();
        }
        
        function updateUserStatus(username, status) {
            const usersList = document.getElementById('users-list');
            let userItem = Array.from(usersList.children).find(
                item => item.dataset.username === username
            );
            
            if (!userItem) {
                userItem = document.createElement('li');
                userItem.dataset.username = username;
                userItem.innerHTML = `
                    <i class="fas fa-circle status-${status}"></i>
                    <span>${username}</span>
                `;
                usersList.appendChild(userItem);
            } else {
                const statusIcon = userItem.querySelector('i');
                statusIcon.className = `fas fa-circle status-${status}`;
            }
        }
        
        function scrollToBottom() {
            const container = document.getElementById('messages-container');
            container.scrollTop = container.scrollHeight;
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Image modal functions
        function openImageModal(src) {
            const modal = document.getElementById('image-modal');
            const modalImg = document.getElementById('modal-image');
            modal.style.display = 'block';
            modalImg.src = src;
        }
        
        function closeImageModal() {
            const modal = document.getElementById('image-modal');
            modal.style.display = 'none';
        }
        
        // Close modal when clicking outside the image
        window.onclick = function(event) {
            const modal = document.getElementById('image-modal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        };
        
        // Initialize with general room
        window.onload = function() {
            joinRoom('general');
            groupExistingMessages();
        };
    </script>
</body>
</html>
